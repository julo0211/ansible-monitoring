Nom : ASUNCIONPrénom : JulesÉcole : IPI BlagnacEntreprise : Orange FranceProjet Ansible - Déploiement d'une Stack de MonitoringIntroductionCe projet a pour objectif de démontrer l'automatisation du déploiement d'une stack de monitoring sur une machine cible (VM Debian) en utilisant Ansible. L'infrastructure est composée de :Grafana : Une interface de visualisation puissante pour la création de tableaux de bord.Prometheus : Un système de collecte et de stockage de métriques en séries temporelles.Node Exporter : Un agent de collecte de métriques système (CPU, mémoire, disque, etc.) pour Prometheus.Note sur Loki : L'intégration de Loki, un agrégateur de logs, a été tentée. Cependant, en raison d'un bug de configuration persistant dans la version de son binaire sur les dépôts Debian, cette partie du projet a été mise de côté pour des raisons de temps, afin de pouvoir livrer une infrastructure fonctionnelle et complète. Le code Ansible pour Loki a été développé, mais ne parvient pas à démarrer le service.Pré-requisPour exécuter ce projet, vous devez disposer des éléments suivants :Une machine de contrôle Ansible : Un système (par exemple, un poste de travail ou une VM) avec Ansible installé.Une machine cible : Une VM Debian 12 avec l'adresse IP 192.168.1.14 (cette adresse peut être modifiée dans le fichier hosts).Accès SSH sans mot de passe : L'authentification par clé SSH doit être configurée depuis la machine de contrôle vers la machine cible pour l'utilisateur distant.Privilèges sudo sans mot de passe : L'utilisateur distant doit avoir les droits sudo configurés pour s'exécuter sans demander de mot de passe (visudo).Structure du ProjetL'organisation du projet respecte les bonnes pratiques d'Ansible, avec des rôles dédiés pour chaque composant :ansible-monitoring/
├── ansible.cfg              # Configuration globale d'Ansible
├── hosts                    # Inventaire des machines cibles
├── site.yml                 # Playbook principal
└── roles/
    ├── common/              # Rôle pour les tâches communes (installation de paquets, création d'utilisateurs)
    │   ├── tasks/
    │   └── vars/
    ├── grafana/             # Rôle pour l'installation et la configuration de Grafana
    │   ├── tasks/
    │   ├── handlers/
    │   └── templates/
    ├── loki/                # Rôle pour Loki et Promtail (non fonctionnel en raison d'un bug)
    │   ├── tasks/
    │   ├── handlers/
    │   └── templates/
    └── prometheus/          # Rôle pour l'installation de Prometheus et Node Exporter
        ├── tasks/
        ├── handlers/
        ├── templates/
        └── vars/
UtilisationPour lancer le déploiement de l'infrastructure, exécutez la commande suivante depuis le répertoire ansible-monitoring/ sur votre machine de contrôle :ansible-playbook site.yml --limit debian_vm

Cette commande orchestrera les tâches suivantes :Installation des pré-requis système (common).Installation de Grafana.Installation de Prometheus et Node Exporter.L'exécution du rôle loki est commentée dans le site.yml pour éviter l'échec du playbook.Fonctionnalités d'Ansible utiliséesCe projet met en évidence plusieurs fonctionnalités clés d'Ansible :Rôles : Le projet est modularisé en rôles (common, grafana, prometheus) pour une meilleure organisation et réutilisabilité du code.Inventaire : Le fichier hosts permet de cibler les machines de manière flexible.become: true : L'élévation de privilèges est utilisée pour exécuter des tâches administratives avec sudo.Variables : Le fichier roles/prometheus/vars/main.yml stocke les versions des logiciels, ce qui permet de les mettre à jour facilement sans modifier le code des tâches.Templates Jinja2 (.j2) : Les fichiers de configuration (prometheus.yml.j2, prometheus.service.j2, etc.) sont générés dynamiquement, ce qui permet de personnaliser les valeurs (par exemple, les adresses IP) en fonction de l'environnement.Handlers : Les services sont redémarrés de manière conditionnelle, uniquement si leurs fichiers de configuration ont été modifiés.Modules : L'utilisation de modules comme ansible.builtin.apt, ansible.builtin.get_url, ansible.builtin.unarchive, et ansible.builtin.systemd permet de gérer les paquets, les binaires et les services de manière déclarative.Vérification du déploiementAprès l'exécution réussie du playbook (failed=0), vous pouvez vérifier le bon fonctionnement de l'infrastructure :1. Services sur la VM DebianVérifiez le statut de Prometheus :ssh tototo@192.168.1.14 'sudo systemctl status prometheus'Le service doit être active (running).Vérifiez le statut de Node Exporter :ssh tototo@192.168.1.14 'sudo systemctl status node_exporter'Le service doit être active (running).Vérifiez les ports d'écoute :ssh tototo@192.168.1.14 'sudo ss -tulnp | grep 9090' (pour Prometheus)ssh tototo@192.168.1.14 'sudo ss -tulnp | grep 9100' (pour Node Exporter)2. Accès aux interfaces WebAccès à Grafana :Ouvrez un navigateur et allez à http://192.168.1.14:3000.Identifiants par défaut : admin / admin.Accès à Prometheus :Ouvrez un navigateur et allez à http://192.168.1.14:9090.Dans le menu Status -> Targets, vous devriez voir les cibles prometheus et node_exporter en statut UP.Ajout de la source de données Prometheus dans Grafana :Dans l'interface de Grafana, allez dans Configuration > Data sources, ajoutez une nouvelle source de données de type Prometheus avec l'URL http://localhost:9090. Après un Save & test, la connexion devrait être un succès.Ce document et le code associé ont été produits par Jules ASUNCION pour son TP à l'IPI Blagnac, avec l'aide d'outils d'assistance IA pour la structuration et la résolution de problèmes complexes.
